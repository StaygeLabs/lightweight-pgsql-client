#!/bin/bash
#
# .git/hooks/prepare-commit-msg
#
# ì´ í›…ì€ Claude Code CLIë¥¼ ì‚¬ìš©í•´ stagedëœ ë³€ê²½ ì‚¬í•­ì„ ê¸°ë°˜ìœ¼ë¡œ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ìžë™ ìƒì„±í•©ë‹ˆë‹¤.

# Gitì´ ì „ë‹¬í•˜ëŠ” ì¸ìžë“¤
COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
# COMMIT_SHA=$3 # (í•„ìš”ì‹œ ì‚¬ìš©)

# --- ìžë™ ìƒì„± ì œì™¸ ì¡°ê±´ ---
# 1. ì‚¬ìš©ìžê°€ -m "ë©”ì‹œì§€" ë˜ëŠ” --amend ì˜µì…˜ì„ ì‚¬ìš©í•œ ê²½ìš°
# 2. ì»¤ë°‹ì´ merge ì»¤ë°‹ì¸ ê²½ìš°
# (ì´ ê²½ìš°, Claudeê°€ ìƒì„±í•œ ë©”ì‹œì§€ë¡œ ë®ì–´ì“°ì§€ ì•Šê³  ê¸°ì¡´ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.)
if [ "$COMMIT_SOURCE" = "message" ] || [ "$COMMIT_SOURCE" = "commit" ] || [ "$COMMIT_SOURCE" = "merge" ]; then
  exit 0
fi

# Claude CLI í™•ì¸
if ! command -v claude &> /dev/null; then
  echo "âŒ Error: claude CLI is not installed" >&2
  echo "Please install Claude Code CLI first" >&2
  exit 0
fi

# --- Claude ìž…ë ¥ ë°ì´í„° ì¤€ë¹„ ---
# 1. stagedëœ diff ë‚´ìš©ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
DIFF_CONTENT=$(git diff --staged)

# 2. stagedëœ ë‚´ìš©ì´ ì—†ìœ¼ë©´ (ì˜ˆ: git commit -a ë¡œ ë³€ê²½ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš°), í›…ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.
#    Gitì´ "no changes added to commit" ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ë„ë¡ ë‘¡ë‹ˆë‹¤.
if [ -z "$DIFF_CONTENT" ]; then
  exit 0
fi

# Diff í¬ê¸° í™•ì¸ ë° ìµœì í™”
DIFF_LENGTH=${#DIFF_CONTENT}
MAX_DIFF_LENGTH=50000  # ì•½ 12,500 tokens

echo "ðŸ“Š Diff size: $DIFF_LENGTH characters" >&2

# Diff ìµœì í™” ì „ëžµ
if [ $DIFF_LENGTH -gt $MAX_DIFF_LENGTH ]; then
  echo "âš ï¸  Diff is large. Using optimized diff strategy..." >&2

  # ë³€ê²½ í†µê³„ (íŒŒì¼ ëª©ë¡ê³¼ ë³€ê²½ ì¤„ ìˆ˜)
  DIFF_STAT=$(git diff --staged --stat)

  # ì¤‘ìš”í•˜ì§€ ì•Šì€ íŒŒì¼ ì œì™¸ (lock files, generated files, etc.)
  OPTIMIZED_DIFF=$(git diff --staged -- \
    ':!package-lock.json' \
    ':!yarn.lock' \
    ':!pnpm-lock.yaml' \
    ':!*.lock' \
    ':!dist/*' \
    ':!build/*' \
    ':!*.min.js' \
    ':!*.min.css' \
    ':!*.map')

  # ìµœì í™”ëœ diff í¬ê¸° í™•ì¸
  OPTIMIZED_LENGTH=${#OPTIMIZED_DIFF}
  echo "ðŸ“‰ Optimized diff size: $OPTIMIZED_LENGTH characters (excluded: lock files, build artifacts)" >&2

  # ì—¬ì „ížˆ í¬ë©´ í†µê³„ ì •ë³´ë¡œ ëŒ€ì²´
  if [ $OPTIMIZED_LENGTH -gt $MAX_DIFF_LENGTH ]; then
    echo "âš ï¸  Still too large. Using summary-based approach..." >&2
    DIFF_CONTEXT="
## Changed Files Summary:
\`\`\`
$DIFF_STAT
\`\`\`

## Detailed Changes (truncated):
\`\`\`
${OPTIMIZED_DIFF:0:30000}
...
(diff truncated - see file statistics above for full context)
\`\`\`
"
  else
    # ìµœì í™”ëœ diff ì‚¬ìš©
    DIFF_CONTEXT="
## Changed Files Summary:
\`\`\`
$DIFF_STAT
\`\`\`

## Detailed Changes:
\`\`\`
$OPTIMIZED_DIFF
\`\`\`
"
  fi
else
  # Diffê°€ ìž‘ìœ¼ë©´ ì „ì²´ ì‚¬ìš©
  DIFF_STAT=$(git diff --staged --stat)
  DIFF_CONTEXT="
## Changed Files Summary:
\`\`\`
$DIFF_STAT
\`\`\`

## Detailed Changes:
\`\`\`
$DIFF_CONTENT
\`\`\`
"
fi

# --- Claude CLI í˜¸ì¶œ ---
# (í„°ë¯¸ë„ì— ë¡œë”© í‘œì‹œë¥¼ ë³´ì—¬ì£¼ì–´ ì‚¬ìš©ìžê°€ ëŒ€ê¸° ì¤‘ìž„ì„ ì•Œë¦½ë‹ˆë‹¤.)
echo "ðŸ¤– Claudeê°€ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ìƒì„± ì¤‘ìž…ë‹ˆë‹¤..." >&2

# 3. Claude CLIë¥¼ í˜¸ì¶œí•˜ì—¬ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
#    Prompt: Conventional Commits í˜•ì‹ì„ ëª…ì‹œí•˜ê³ , "ì˜¤ì§ ë©”ì‹œì§€ë§Œ" ë°˜í™˜í•˜ë„ë¡ ê°•ë ¥í•˜ê²Œ ìš”ì²­í•©ë‹ˆë‹¤.
GENERATED_MSG=$(claude --print "Generate a concise Conventional Commit message for these staged changes:

Rules for the commit message:
1. Format: type(scope): description
2. type must be one of: feat, fix, docs, style, refactor, test, chore
3. scope is optional but recommended (e.g., api, repo, service, worker)
4. description must be:
   - In English
   - Lowercase (not sentence-case, start-case, pascal-case, upper-case)
   - Less than 50 characters
   - Clear and concise
5. Output ONLY the commit message, no explanation or markdown formatting.

$DIFF_CONTEXT")

# --- ê²°ê³¼ ì²˜ë¦¬ ---
# 4. Claudeê°€ ì‘ë‹µì„ ìƒì„±í–ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
if [ -z "$GENERATED_MSG" ]; then
  echo "âš ï¸  Claudeê°€ ë©”ì‹œì§€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìž‘ì„±í•˜ì„¸ìš”." >&2
  # ì»¤ë°‹ì„ ì¤‘ë‹¨ì‹œí‚¤ì§€ ì•Šê³ , ì‚¬ìš©ìžê°€ ì§ì ‘ ìž‘ì„±í•˜ë„ë¡ 0ìœ¼ë¡œ ì¢…ë£Œí•©ë‹ˆë‹¤.
  exit 0
fi

EXISTING_MSG=$(cat "$1")

# 5. ìƒì„±ëœ ë©”ì‹œì§€ë¥¼ Git ì»¤ë°‹ ë©”ì‹œì§€ íŒŒì¼($1)ì— ë®ì–´ì”ë‹ˆë‹¤.
#    (ì´ê²ƒì´ í›…ì´ ìž‘ë™í•˜ëŠ” í•µì‹¬ìž…ë‹ˆë‹¤.)
echo "${GENERATED_MSG}\n${EXISTING_MSG}" > $COMMIT_MSG_FILE

echo "âœ… Claudeê°€ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ìžë™ ìƒì„±í–ˆìŠµë‹ˆë‹¤." >&2

exit 0


